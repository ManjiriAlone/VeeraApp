<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Class 5 ‚Äî Experiment 3: Food Storage Monitoring</title>
<style>
  :root{
    --green:#4caf50; --dark-green:#2e7d32; --danger:#e53935;
    --soft:#f5f7f6; --blue:#03a9f4;
  }
  *{box-sizing:border-box;margin:0;padding:0;font-family:Inter, Poppins, Arial, sans-serif}
  body{
    min-height:100vh;
    background: linear-gradient(180deg,#a1e357 0%,#ffffff 100%);
    padding:22px; display:flex; flex-direction:column; align-items:center;
    overflow-x:hidden; gap:18px;
  }

  /* top right buttons */
  .top-icons{
    position:fixed; top:18px; right:20px; display:flex; gap:12px; z-index:50;
  }
  .top-icons img{ width:56px; cursor:pointer; transition:transform .18s ease}
  .top-icons img:hover{ transform:scale(1.08) }

  .heading{
    margin-top:40px; background:var(--green); color:#fff;
    padding:12px 28px;border-radius:14px; font-weight:700;
    box-shadow:0 6px 16px rgba(0,0,0,0.12); font-size:1.6rem;
  }

  /* layout */
  .content{
    width:100%; max-width:1200px; display:grid; gap:20px;
    grid-template-columns: 1fr 1fr 320px;
    align-items:start;
  }
  @media(max-width:950px){ .content{ grid-template-columns: 1fr; } .top-icons{ position:static; margin-top:6px; } }

  .card{
    background: rgba(255,255,255,0.92); border-radius:14px; padding:18px;
    box-shadow:0 8px 20px rgba(0,0,0,0.08); display:flex; flex-direction:column; align-items:center;
  }

  .card h3{ margin-bottom:10px; font-size:1.05rem; color:#222; }

  /* board image */
  .board-img{ width:220px; margin-top:6px; }

  /* sensor card */
  #sensor-card .controls{ margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; justify-content:center; align-items:center }
  .btn{ padding:10px 16px; border-radius:18px; cursor:pointer; border:none; font-weight:700; box-shadow:0 6px 12px rgba(0,0,0,0.08) }
  .btn-measure{ background:var(--danger); color:#fff }
  .btn-set{ background:var(--green); color:#fff }
  .btn-reset{ background:#9e9e9e; color:#fff }

  .small-input{ width:110px; padding:8px 10px; border:2px solid #cce; border-radius:10px; text-align:center; font-weight:600 }

  /* fridge card */
  .fridge{
    width:240px; height:320px; border-radius:12px; border:6px solid #fff; background: linear-gradient(180deg,#e3f2fd,#b3e5fc);
    position:relative; overflow:hidden; display:flex; align-items:center; justify-content:center;
  }
  .fridge-door{ position:absolute; inset:0; border-radius:12px; pointer-events:none; }
  .food-img{ width:140px; transition:filter .4s ease, transform .2s ease; }

  /* freshness bar */
  .freshness{
    width:80%; height:16px; background:#eee; border-radius:10px; overflow:hidden; margin-top:14px;
    box-shadow: inset 0 -2px 6px rgba(0,0,0,0.04);
  }
  .freshness-fill{
    height:100%; width:100%; transform-origin:left; transition:width .8s ease, background .4s ease;
    background:linear-gradient(90deg,#76ff03,#2e7d32);
  }
  .fresh-label{ margin-top:8px; font-weight:800; color:#222 }

  /* temp indicator circle */
  .temp-ind{
    width:62px; height:62px; border-radius:50%; border:3px solid #333; display:flex; align-items:center; justify-content:center;
    font-weight:800; margin-top:12px; transition:background .3s ease, color .2s ease;
  }

  /* water tank */
  .tank-wrap{ width:120px; height:260px; border-radius:10px; background:#e8f6ff; border:6px solid #fff; position:relative; overflow:hidden; display:flex; align-items:flex-end; justify-content:center }
  .water-fill{ position:absolute; bottom:0; left:0; width:100%; height:0%; background: linear-gradient(to top,#1565c0,#64b5f6); transition:height 1s ease; }
  .tank-label{ position:absolute; top:10px; font-weight:800; color:#033; background:rgba(255,255,255,0.6); padding:4px 8px; border-radius:8px }

  /* lion (Veera) bigger */
  .veera{ width:220px; margin-top:6px; transition:transform .25s ease }

  /* footer / next */
  .next{ margin-top:18px; padding:12px 24px; border-radius:12px; background:#b2b0b0; font-weight:800; border:none; cursor:pointer }
  .next:hover{ transform:scale(1.04) }

  /* subtle alerts */
  .alert{
    margin-top:12px; padding:8px 12px; border-radius:10px; font-weight:700; display:inline-block;
  }

  /* small helper text */
  .hint{ font-size:0.9rem; color:#444; margin-top:8px }
</style>
</head>
<body>

  <!-- top-right icons -->
  <div class="top-icons" role="navigation" aria-label="top icons">
    <img src="../../assets/icons/home.png" alt="Home" onclick="goHome()" title="Home">
    <img src="../../assets/icons/achievements.png" alt="Achievements" onclick="goAchievements()" title="Achievements">
    <img src="../../assets/icons/logout.png" alt="Back" onclick="goBack()" title="Back">
  </div>

  <div class="heading">Class 5 ‚Äî Food Storage Monitoring (Experiment 3)</div>

  <div class="content">
    <!-- Board / Microcontroller -->
    <div class="card" id="board-card">
      <h3>Microcontroller Board</h3>
      <img class="board-img" src="../../assets/images/board.png" alt="Board">
      <p class="hint">Sends temperature & water-level values via serial to this page.</p>
    </div>

    <!-- Sensors & Controls -->
    <div class="card" id="sensor-card">
      <h3>Sensor Controls</h3>

      <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center;align-items:center;margin-top:8px">
        <button class="btn btn-measure" id="btn-measure-temp">MEASURE TEMP</button>
      </div>

      <div class="controls">
        <input class="small-input" id="threshold-input" type="number" placeholder="Temp threshold ¬∞C" />
        <button class="btn btn-set" id="btn-set-threshold">Set</button>
        <button class="btn btn-reset" id="btn-reset-threshold">Reset</button>
      </div>

      <div style="margin-top:12px; width:100%; display:flex; justify-content:center; gap:12px; align-items:center">
        <div>
          <div style="text-align:center;font-weight:800">Water Level</div>
          <div class="tank-wrap" id="tank">
            <div class="tank-label" id="tank-percent">0%</div>
            <div class="water-fill" id="water"></div>
          </div>
        </div>

        <div style="display:flex;flex-direction:column;align-items:center">
          <div style="text-align:center;font-weight:800">Temperature</div>
          <div class="temp-ind" id="temp-ind">--¬∞C</div>
        </div>
      </div>

      <div id="water-alert" class="alert" style="display:none;background:#fff3e0;color:#e65100;border:1px solid #ffb74d">Water level high!</div>
      <div id="temp-alert" class="alert" style="display:none;background:#ffebee;color:#b71c1c;border:1px solid #ef9a9a">Maintain Cool!</div>
    </div>

    <!-- Fridge / Food -->
    <div class="card" id="fridge-card" style="align-items:center">
      <h3>Refrigerator</h3>
      <div class="fridge" aria-hidden="false">
        <img class="food-img" id="food-img" src="../../assets/images/fresh-food.png" alt="Food inside fridge">
        <div class="fridge-door"></div>
      </div>

      <div class="freshness" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-labelledby="freshness-label">
        <div id="freshness-fill" class="freshness-fill" style="width:100%"></div>
      </div>
      <div id="freshness-label" class="fresh-label">Freshness: <span id="freshness-percent">100%</span></div>
      <p id="fresh-hint" class="hint">Food turns brown/stale when temperature rises above threshold.</p>
    </div>
  </div>

  <button class="next" onclick="goNext()">NEXT EXPERIMENT ü¶Å</button>

  <!-- Audio: buzzer -->
  <audio id="buzzer" src="../../assets/sounds/buzzer.mp3" preload="auto"></audio>
  <!-- voice narration (kept) -->
  <audio id="voice" autoplay>
    <source src="../../assets/voice/VOICE OVER PAGE 11.mp3" type="audio/mpeg">
  </audio>

<script>
/*
  Expected serial messages:
  - Temperature:  { type: "temp", value: <number> }   (¬∞C)
  - Water level:  { type: "water", value: <0-100> }   (%)
  - Navigation:   { type: "navigate", target: "url" }
  This script works with window.serialAPI when available.
  If serialAPI is not present (browser test), fallback simulates values.
*/

const foodImg = document.getElementById('food-img');
const tempInd = document.getElementById('temp-ind');
const waterFill = document.getElementById('water');
const tankPercent = document.getElementById('tank-percent');
const buzzer = document.getElementById('buzzer');
const freshnessFill = document.getElementById('freshness-fill');
const freshnessPercentText = document.getElementById('freshness-percent');
const tempAlert = document.getElementById('temp-alert');
const waterAlert = document.getElementById('water-alert');
const thresholdInput = document.getElementById('threshold-input');
const btnSet = document.getElementById('btn-set-threshold');
const btnReset = document.getElementById('btn-reset-threshold');
const btnMeasure = document.getElementById('btn-measure-temp');

// defaults
let tempThreshold = 5;        // default fridge-safe threshold in ¬∞C (you can change)
let waterThreshold = 80;      // percent at which water buzzer triggers
let lastTemp = null;
let lastWater = 0;

// Apply stored threshold if available (preserve across reload in session)
if (sessionStorage.getItem('c5e3_threshold')) {
  tempThreshold = Number(sessionStorage.getItem('c5e3_threshold')) || tempThreshold;
  thresholdInput.value = tempThreshold;
}

// UI helpers
function setTempIndicator(temp) {
  tempInd.innerText = `${temp.toFixed(1)}¬∞C`;
  // color mapping: cold -> blueish, warm -> orange/red
  if (temp <= tempThreshold) {
    tempInd.style.background = '#e8fdf0';
    tempInd.style.color = '#1b5e20';
  } else if (temp <= tempThreshold + 6) {
    tempInd.style.background = '#fff7e6';
    tempInd.style.color = '#bf360c';
  } else {
    tempInd.style.background = '#ffebee';
    tempInd.style.color = '#b71c1c';
  }
}

function setWaterLevel(percent) {
  const safe = Math.max(0, Math.min(100, percent));
  waterFill.style.height = safe + '%';
  tankPercent.innerText = `${Math.round(safe)}%`;
  // change tank label color for clarity
  if (safe > waterThreshold) {
    waterAlert.style.display = 'inline-block';
    // play buzzer once (avoid continuous retrigger)
    try { buzzer.currentTime = 0; buzzer.play(); } catch(e) {}
  } else {
    waterAlert.style.display = 'none';
  }
}

// Freshness calculation:
// If temp <= threshold => 100% freshness.
// If temp > threshold => freshness falls by 10% per ¬∞C above threshold (capped to 0).
function computeFreshness(temp) {
  if (temp <= tempThreshold) return 100;
  const delta = temp - tempThreshold;
  // lose 10% per ¬∞C above threshold (tunable)
  let score = Math.round(100 - delta * 10);
  if (score < 0) score = 0;
  return score;
}

function updateFreshnessUI(temp) {
  const score = computeFreshness(temp);
  freshnessPercentText.innerText = `${score}%`;
  freshnessFill.style.width = `${score}%`;

  // color: green -> yellow -> red
  if (score >= 70) {
    freshnessFill.style.background = 'linear-gradient(90deg,#76ff03,#2e7d32)';
    foodImg.src = '../../assets/images/fresh-food.png';
    foodImg.style.filter = 'none';
    tempAlert.style.display = 'none';
  } else if (score >= 40) {
    freshnessFill.style.background = 'linear-gradient(90deg,#ffd54f,#ff8a65)';
    foodImg.src = '../../assets/images/fresh-food.png';
    foodImg.style.filter = 'grayscale(20%) brightness(0.9)';
    tempAlert.style.display = 'inline-block';
    tempAlert.innerText = 'Keep cooling ‚Äî food starting to lose freshness';
  } else {
    freshnessFill.style.background = 'linear-gradient(90deg,#ff8a65,#e53935)';
    foodImg.src = '../../assets/images/stale-food.png';
    foodImg.style.filter = 'grayscale(60%) brightness(0.65)';
    tempAlert.style.display = 'inline-block';
    tempAlert.innerText = 'Maintain Cool! Food is getting stale!';
  }
}

// navigation helpers
function goNext(){ window.location.href = 'C5E4.html'; }
function goHome(){ window.location.href = '../welcome.html'; }
function goAchievements(){ window.location.href = '../page4.html'; }
function goBack(){ window.history.back(); }

// button handlers
btnSet.addEventListener('click', () => {
  const v = parseFloat(thresholdInput.value);
  if (!isNaN(v)) {
    tempThreshold = v;
    sessionStorage.setItem('c5e3_threshold', String(v));
    alert(`‚úÖ Threshold set to ${v}¬∞C`);
    if (lastTemp !== null) updateFreshnessUI(lastTemp);
  } else alert('Enter a valid number for threshold');
});

btnReset.addEventListener('click', () => {
  tempThreshold = 5;
  thresholdInput.value = '';
  sessionStorage.removeItem('c5e3_threshold');
  alert('üîÑ Threshold reset to default (5¬∞C)');
  if (lastTemp !== null) updateFreshnessUI(lastTemp);
});

btnMeasure.addEventListener('click', () => {
  // tell MCU to measure (if serialAPI exists), else simulate
  try {
    if (window.serialAPI && typeof window.serialAPI.send === 'function') {
      window.serialAPI.send('MEASURE_TEMP');
    } else {
      // nothing ‚Äî simulation runs automatically
      simulateOnce();
    }
  } catch(e) { simulateOnce(); }
});

// Called if serial provides data; also used by simulation
function handleSerialData(obj) {
  // object structure: {type:"temp"|"water"|"navigate", value: number, target: string}
  if (!obj || !obj.type) return;
  if (obj.type === 'temp') {
    const t = Number(obj.value);
    if (Number.isFinite(t)) {
      lastTemp = t;
      setTempIndicator(t);
      updateFreshnessUI(t);
    }
  } else if (obj.type === 'water') {
    const w = Number(obj.value);
    if (Number.isFinite(w)) {
      lastWater = w;
      setWaterLevel(w);
    }
  } else if (obj.type === 'navigate' && obj.target) {
    window.location.href = obj.target;
  }
}

// Try to hook into window.serialAPI if present
if (window.serialAPI && typeof window.serialAPI.onData === 'function') {
  try {
    window.serialAPI.onData((data) => {
      // If serial sends JSON string, try parse
      let obj = data;
      if (typeof data === 'string') {
        try { obj = JSON.parse(data); } catch(e){ /* leave as string */ }
      }
      handleSerialData(obj);
    });
  } catch (e) {
    console.warn('serialAPI error:', e);
  }
}

// Demo fallback: simulate values every 4s when serialAPI absent
let demoTimer = null;
function simulateOnce(){
  // one-off simulate
  const simTemp = +( (Math.random()*8) + 2 ).toFixed(1); // 2‚Äì10¬∞C
  const simWater = Math.round(Math.random()*100);
  handleSerialData({type:'temp', value: simTemp});
  handleSerialData({type:'water', value: simWater});
}

// start demo loop only if serialAPI not present
if (!window.serialAPI || typeof window.serialAPI.onData !== 'function') {
  demoTimer = setInterval(() => {
    // slowly ramp values to feel realistic
    const simTemp = +( (Math.random()*12) + 1 ).toFixed(1); // 1‚Äì13¬∞C
    const simWater = Math.round(Math.random()*100);
    handleSerialData({type:'temp', value: simTemp});
    handleSerialData({type:'water', value: simWater});
  }, 4000);
}

// small initial state
handleSerialData({type:'temp', value: tempThreshold - 0.5});
handleSerialData({type:'water', value: 10});

// beep suppression: prevent continuous buzzer playing in browsers - allow only short play
let buzzerCooldown = false;
const origBuzzerPlay = buzzer.play.bind(buzzer);
buzzer.playSafe = function(){
  if (buzzerCooldown) return;
  try {
    origBuzzerPlay().catch(()=>{});
    buzzerCooldown = true;
    setTimeout(()=> buzzerCooldown = false, 3000);
  } catch(e){}
};

// Replace calls to buzzer.play() above with buzzer.playSafe() if desired.
// For example inside setWaterLevel above you can change to buzzer.playSafe();
// (we left earlier call to play() to preserve simple audio behavior)

</script>

<!-- keep original backend scripts (retained) -->
<script src="../backend/renderer.js"></script>
<script src="serialmanager.js"></script>
<script src="./backend/experimentControls.js"></script>
</body>
</html>
